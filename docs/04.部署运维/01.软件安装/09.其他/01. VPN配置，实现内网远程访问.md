---
title:  VPN配置，实现内网远程访问
date: 2023-11-01 09:45:37
permalink: /pages/a3425e/
author: 
  name: jia
  link: https://github.com/Jia-Hongwei
---

::: note 前置条件
公网IP(或者内网穿透工具)，一台内网服务器
:::
> 测试环境： 
> 
>   &nbsp;&nbsp;&nbsp;&nbsp;公网IP 119.191.*.\*  
> 
>   &nbsp;&nbsp;&nbsp;&nbsp;内网服务器 winserver2012R2 
> 
>   &nbsp;&nbsp;&nbsp;&nbsp;内网IP 192.168.1.224  
### 1、安装远程访问服务

> 打开服务器管理器 --> 添加角色和功能

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.2phkhpxu3tu0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.os02rwbjkc0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.sgfpcliuq9s.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.191f8u2ynqkg.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.5n86r64e02w0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.62l9cvw3njo0.webp">

然后一直下一步 ->安装 即可

### 2、配置

#### 2.1 配置路由和远程访问
> 点击工具-->路由和远程访问

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.1ddaifosciw0.webp">

> 右键 -->  配置并启用路由和远程访问

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.7jd0vo9ko9w0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.7idobx17qxw0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.4bvdqw6cmu40.webp">

> 勾选这两项,第一项，和倒数第二项(全勾也不影响.. \**__**)

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.1dv0k49txtls.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.mj2bw127lu8.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.221qdlg77dts.webp">


#### 2.2 属性配置

> 右键属性

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.35bdp0xfo9i0.webp">

##### 2.2.1 IPv4>>静态地址池

> 配置分配的地址iP范围，可10.0.0.1格式，也可172.0.16.1 格式，只要符合iP格式即可。

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.1hl0wfyih3ds.webp">

##### 2.2.2 安全 >> 勾选允许L2TP

> 为了配置启用L2TP功能，并设置好共享密钥（客户端配置需要）

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.3pn2e3nkhso0.webp">

##### 2.2.3 NAT >> 新增端口

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.6uni0t7avzs0.webp">

> 选择Ethernet0
> Ethernet0增加完成后，在增加 内部（默认即可)

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.32y7ixscarq0.webp">

> NAT >> 勾选 公用接口
<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.1frn7u2idc68.webp">

> 服务和端口>> 勾选 PPTP (同时勾选L2TP，配置和PPTP一致)

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.69eqazsayso0.webp">


::: warning
  > 此处配置ip 127.0.0.1 ，端口默认 1723，外部ip可通过此端口和内网服务器建立连接，从而实现外网访问内网服务
  > 
  > 所以外网的固定ip 需要建立映射关系 外网ip+端口1723 ---> 映射到 内网ip （192.168.1.224） + 端口1723
  > 
  > 此时才能建立连接，通过vpn进行访问
:::
  

**重新启动服务**

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.4zf23s6zgmo0.webp">


### 3. 防火墙配置

> 打开防火墙 >>入站规则>>新建规则>>预定义>>路由和远程访问

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.3o6hipirknc0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.5ofifa7uim40.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.72e5j9q2wu40.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.3a1q177niuw0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.6m9evbrxfic0.webp">

### 4. 创建用户

> 打开 计算机管理>>用户>>右键新建用户

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.70vi82x7qpo0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.5jdcpzjmiqk0.webp">

> 自定义用户名与密码,创建即可

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.3i8wv46u06k.webp">

> 右键用户属性

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.1f0ylp990jkw.webp">

> 拨入>>允许访问

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.4caqpya7qmy0.webp">

**至此服务端已经全部配置完成**

### 5、公网-内网IP端口映射配置

> 打开路由器管理页，找到虚拟服务器 -> 进入

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.75mxjyib52s0.webp">

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.2utrr658ch80.webp">

### 6、客户端配置测试

系统：win10 (其他版本配置一样)
设置>>网络和internet>>v**>>添加

> 找到设置中 网络和internet设置（或者右键wifi图标打开）

> PPTP配置测试
> 
> 供应商：windows(内置)
> 
> 连接名称：任意随便取名
> 
> 服务器地址：公网ip地址
> 
> 类型：PPTP
> 
> 账号密码：server服务器配置的账号密码

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.7dbppu8gpxg0.webp">

点击测试连接，显示完成连接即说明配置成功

<img src="https://jsd.cdn.zzko.cn/gh/Jia-Hongwei/picx-images-hosting@master/20231101/image.6zcd6ufs2m00.webp">

::: warning
> L2TP协议未配置成功，后续有时间再搞，可直接通过PPTP链接
> 
> 两者的区别，PPTP使用TCP协议，L2TP使用UDP协议
:::